# ===============================================================
# üêß Fixa's Final Unified Zsh Config (Arch Linux + WezTerm)
# ===============================================================

# 1. PATHS & OH-MY-ZSH BOOTSTRAP
export ZSH="$HOME/.oh-my-zsh"
export PATH="/home/dhili/.npm-global/bin:$PATH"
export PATH="$HOME/.local/bin:$PATH"

ZSH_THEME="robbyrussell"
plugins=(git zsh-syntax-highlighting zsh-shift-select)

# Load Completions
fpath=(/usr/share/zsh/site-functions $fpath)

# Initialize Oh My Zsh
source $ZSH/oh-my-zsh.sh

# Load zsh-autosuggestions
if [[ -f /usr/share/zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh ]]; then
    source /usr/share/zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh
fi

# 2. SYSTEM CONFIGURATION
export VISUAL=nano
export EDITOR="$VISUAL"

[[ -o interactive ]] && fastfetch

# 3. ALIASES
alias Hyprland='start-hyprland'
alias updt="paru -Syu; rm -rf \$HOME/.npm-global/lib/node_modules/@google/gemini-cli; rm -f \$HOME/.config/configstore/update-notifier-@google/gemini-cli.json; npm install -g @google/gemini-cli@nightly"

clean() {
    # 1. Root/System Cleanup (Requires Sudo)
    /home/dhili/.local/bin/system-cleanup

    # 2. User/Home Cleanup
    echo "üßº Clearing user caches and trash..."
    rm -rf ~/.cache/paru/clone/*
    rm -rf ~/.cache/ms-playwright/*
    rm -rf ~/.local/share/Trash/*
    rm -rf ~/.npm/_npx ~/.npm/_cacache

    echo "‚ú® Cleaning Gemini internal history..."
    find ~/.gemini/history -type f -name "*.pack" -size +100M -delete 2>/dev/null
    find ~/.gemini/history -type f -name "tmp_pack_*" -delete 2>/dev/null
    
    echo "üéâ All cleanup (Root + User) complete!"
}

# 4. ZLE & VISUALS
zle_highlight+=(region:bg=yellow,fg=black)

# Basic Navigation
bindkey "^W" backward-kill-word
bindkey "^[d" kill-word
bindkey "^[[1;5D" backward-word
bindkey "^[[1;5C" forward-word

# ===============================================================
# üöÄ SMART EDITING WIDGETS (Hybrid Fallback)
# ===============================================================

# --- HELPER: CONTINUOUS WORD MOVEMENT (Whitespace Only) ---
# We temporarily change WORDCHARS to exclude everything, making Zsh treat
# only spaces as delimiters for these specific actions.
_continuous_jump_forward() {
    local WORDCHARS=''
    zle forward-word
}
zle -N _continuous_jump_forward

_continuous_jump_backward() {
    local WORDCHARS=''
    zle backward-word
}
zle -N _continuous_jump_backward

# --- HELPER: SELECTION WRAPPERS ---
# These ensure we start selecting if we haven't already.
_select_continuous_right() {
    ((REGION_ACTIVE)) || zle set-mark-command
    _continuous_jump_forward
}
zle -N _select_continuous_right

_select_continuous_left() {
    ((REGION_ACTIVE)) || zle set-mark-command
    _continuous_jump_backward
}
zle -N _select_continuous_left

_select_char_right() {
    ((REGION_ACTIVE)) || zle set-mark-command
    zle forward-char
}
zle -N _select_char_right

_select_char_left() {
    ((REGION_ACTIVE)) || zle set-mark-command
    zle backward-char
}
zle -N _select_char_left

_select_home() {
    ((REGION_ACTIVE)) || zle set-mark-command
    zle beginning-of-line
}
zle -N _select_home

_select_end() {
    ((REGION_ACTIVE)) || zle set-mark-command
    zle end-of-line
}
zle -N _select_end

_select_all() {
    zle beginning-of-buffer-or-history
    zle set-mark-command
    zle end-of-buffer-or-history
}
zle -N _select_all

# --- SMART CLIPBOARD WIDGETS ---

# 1. COPY WIDGET (Triggered by ^[[1;20~)
zsh-copy-widget() {
    if (( REGION_ACTIVE )); then
        zle copy-region-as-kill
        if command -v wl-copy > /dev/null; then
             printf "%s" "$CUTBUFFER" | wl-copy
        elif command -v xclip > /dev/null; then
             printf "%s" "$CUTBUFFER" | xclip -selection clipboard
        fi
        REGION_ACTIVE=0
        zle -R
        zle -M "üêß Copied"
    else
        zle -M "‚ö†Ô∏è Nothing to copy"
    fi
}
zle -N zsh-copy-widget

# 2. CUT WIDGET (Triggered by ^[[1;24~)
zsh-cut-widget() {
    if (( REGION_ACTIVE )); then
        zle kill-region
        if command -v wl-copy > /dev/null; then
             printf "%s" "$CUTBUFFER" | wl-copy
        elif command -v xclip > /dev/null; then
             printf "%s" "$CUTBUFFER" | xclip -selection clipboard
        fi
        zle -R
        zle -M "üêß Cut"
    fi
}
zle -N zsh-cut-widget

# 3. PASTE / OVERWRITE WIDGET (Triggered by ^[[1;21~)
# WezTerm sends this first to clear selection, then sends text.
clear-selection-widget() {
  if (( REGION_ACTIVE )); then
    zle kill-region # Delete selected text first
    zle -R
  fi
}
zle -N clear-selection-widget

# 4. DELETE SELECTION ONLY (Triggered by ^[[1;23~)
delete-region-widget() {
    if (( REGION_ACTIVE )); then
        zle kill-region
        zle -R
    fi
}
zle -N delete-region-widget

# --- ADVANCED CLI WIDGETS ---

smart-sudo() {
    [[ -z $BUFFER ]] && zle up-history
    if [[ $BUFFER != sudo\ * ]]; then
        BUFFER="sudo $BUFFER"
        CURSOR=$((CURSOR+5))
    else
        BUFFER="${BUFFER#sudo }"
        CURSOR=$((CURSOR-5))
    fi
}
zle -N smart-sudo

soft-newline() {
    zle self-insert-unmeta
}
zle -N soft-newline


# ===============================================================
# üéπ KEYBINDINGS (The Grand Map)
# ===============================================================

# 1. NAVIGATION (CONTINUOUS)
bindkey "^[[1;5C" _continuous_jump_forward   # Ctrl + Right
bindkey "^[[1;5D" _continuous_jump_backward  # Ctrl + Left

# 2. SELECTION (CONTINUOUS & PRECISE)
bindkey "^[[1;6C" _select_continuous_right   # Ctrl + Shift + Right
bindkey "^[[1;6D" _select_continuous_left    # Ctrl + Shift + Left
bindkey "^[[1;2C" _select_char_right         # Shift + Right
bindkey "^[[1;2D" _select_char_left          # Shift + Left
bindkey "^[[1;2H" _select_home               # Shift + Home
bindkey "^[[1;2F" _select_end                # Shift + End
bindkey "^A"      _select_all                # Ctrl + A

# 3. CLIPBOARD & EDITING (FIXA LOGIC)
bindkey "^[[1;20~" zsh-copy-widget           # Ctrl + Shift + C
bindkey "^[[1;24~" zsh-cut-widget            # Ctrl + Shift + X
bindkey "^[[1;21~" clear-selection-widget    # Ctrl + Shift + V (Pre-paste)
bindkey "^[[1;23~" delete-region-widget      # Ctrl + Shift + Backspace

bindkey "^Z"       undo                      # Ctrl + Shift + Z (Mapped via WezTerm)
bindkey "^_"       redo                      # Ctrl + Shift + _

# 4. STANDARD & SYSTEM
bindkey "^[[H"     beginning-of-line         # Home
bindkey "^[[F"     end-of-line               # End
bindkey "^[[3~"    delete-char               # Delete Key
bindkey "^?"       backward-delete-char      # Backspace
bindkey "^H"       backward-delete-char      # Ctrl + Backspace (sends ^H or ^W depending on term)
bindkey "^W"       backward-kill-word        # Ctrl + W (Standard)
bindkey "^[[3;5~"  kill-word                 # Ctrl + Delete (Forward word kill)

bindkey "^[s"      smart-sudo                # Alt + S
bindkey "^M"       accept-line               # Enter
bindkey "^J"       soft-newline              # Shift + Enter (Mapped via WezTerm)

# 5. HISTORY & SEARCH
bindkey "^[[A"     up-line-or-history        # Up Arrow
bindkey "^[[B"     down-line-or-history      # Down Arrow
bindkey "^R"       history-incremental-search-backward

# --- OVERWRITE LOGIC ---
overwrite-selection() {
  if (( REGION_ACTIVE )); then zle kill-region; fi
  zle .self-insert
}
zle -N self-insert overwrite-selection
