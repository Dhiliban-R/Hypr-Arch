# ===============================================================
# ðŸ§ Fixa's Final Unified Zsh Config (Arch Linux + WezTerm)
# ===============================================================

# 1. PATHS & OH-MY-ZSH BOOTSTRAP
export ZSH="$HOME/.oh-my-zsh"
export PATH="/home/dhili/.npm-global/bin:$PATH"
export PATH="$HOME/.local/bin:$PATH"

ZSH_THEME="robbyrussell"
plugins=(git zsh-syntax-highlighting zsh-shift-select)

# Load Completions
fpath=(/usr/share/zsh/site-functions $fpath)

# Initialize Oh My Zsh
source $ZSH/oh-my-zsh.sh

# Load zsh-autosuggestions (Manual Source as per your setup)
source /usr/share/zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh

# 2. SYSTEM CONFIGURATION
export VISUAL=nano
export EDITOR="$VISUAL"
fastfetch

# 3. CUSTOM ALIASES (Including Gemini Nightly Logic)
alias updt="paru -Syu; rm -rf \$HOME/.npm-global/lib/node_modules/ @google/gemini-cli; rm -f \$HOME/.config/configstore/update-notifier- @google/gemini-cli.json; npm install -g @google/gemini-cli@nightly"
alias Hyprland='start-hyprland'

# 4. THE 'CLEAN' UTILITY
clean() {
    echo "ðŸ§¹ Starting system cleanup..."
    if pacman -Q pacman-contrib > /dev/null 2>&1; then
        echo "ðŸ“¦ Cleaning package cache..."
        sudo paccache -rk2
    else
        echo "âš ï¸ 'pacman-contrib' not found. Skipping paccache."
    fi

    orphans=$(pacman -Qtdq)
    if [ -n "$orphans" ]; then
        echo "ðŸ—‘ï¸ Removing orphaned packages..."
        sudo pacman -Rns $orphans --noconfirm
    else
        echo "âœ¨ No orphaned packages found."
    fi

    echo "ðŸ“œ Limiting system logs to 50MB..."
    sudo journalctl --vacuum-size=50M

    echo "ðŸ§¼ Clearing caches and trash..."
    rm -rf ~/.cache/paru/clone/*
    rm -rf ~/.cache/ms-playwright/*
    rm -rf ~/.local/share/Trash/*
    rm -rf ~/.npm/_npx ~/.npm/_cacache

    echo "âœ¨ Cleaning Gemini internal history..."
    find ~/.gemini/history -type f -name "*.pack" -size +100M -delete 2>/dev/null
    find ~/.gemini/history -type f -name "tmp_pack_*" -delete 2>/dev/null

    echo "âœ… Cleanup complete!"
    echo "---"
    df -h /
}

# 5. KEYBOARD NAVIGATION & VISUALS
zle_highlight+=(region:bg=yellow,fg=black)

# Basic Keybindings
bindkey "^W" backward-kill-word             # Ctrl+Backspace
bindkey "^[d" kill-word                    # Ctrl+Delete (Alt+d)
bindkey "^[[1;5D" backward-word            # Ctrl+Left
bindkey "^[[1;5C" forward-word             # Ctrl+Right

# 6. ðŸ§ SMART CLIPBOARD & SELECTION WIDGETS
# These handle the signals sent by your wezterm.lua

gemini-copy() {
    if (( REGION_ACTIVE )); then
        zle copy-region-as-kill
        if [[ "$XDG_SESSION_TYPE" == "wayland" ]]; then
            printf "%s" "$CUTBUFFER" | wl-copy
        else
            printf "%s" "$CUTBUFFER" | xclip -selection clipboard
        fi
        REGION_ACTIVE=0
        zle -R # Refresh screen to clear highlight
    fi
}
zle -N gemini-copy

gemini-cut() {
    if (( REGION_ACTIVE )); then
        zle kill-region
        if [[ "$XDG_SESSION_TYPE" == "wayland" ]]; then
            printf "%s" "$CUTBUFFER" | wl-copy
        else
            printf "%s" "$CUTBUFFER" | xclip -selection clipboard
        fi
    fi
}
zle -N gemini-cut

gemini-paste() {
    if (( REGION_ACTIVE )); then
        zle kill-region
    fi
    local p_data
    if [[ "$XDG_SESSION_TYPE" == "wayland" ]]; then
        p_data=$(wl-paste 2>/dev/null)
    else
        p_data=$(xclip -selection clipboard -o 2>/dev/null)
    fi
    LBUFFER+="$p_data"
}
zle -N gemini-paste

gemini-delete() {
    if (( REGION_ACTIVE )); then
        zle kill-region
    fi
}
zle -N gemini-delete

# 7. OVERWRITE-ON-TYPE LOGIC
overwrite-selection() {
    if (( REGION_ACTIVE )); then
        zle kill-region
    fi
    zle .self-insert
}
zle -N self-insert overwrite-selection

# 8. BINDING WEZTERM SIGNALS
bindkey "\x1b_copy"   gemini-copy
bindkey "\x1b_cut"    gemini-cut
bindkey "\x1b_paste"  gemini-paste
bindkey "\x1b_delsel" gemini-delete

# (End of file)