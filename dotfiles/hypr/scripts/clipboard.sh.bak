#!/bin/bash

# =============================================================================
# clipboard.sh: Multi-category Clipboard Manager with Auto-Paste
# =============================================================================

STYLE="$HOME/.config/wofi/clipboard.css"
WOFI_CMD="wofi --dmenu --width 600 --cache-file /dev/null --style $STYLE"

# 1. Select Category
category=$(echo -e "󰋚 All\n󰦨 Text Only\n󰉏 Images Only\n󰃢 Clear History" | $WOFI_CMD --prompt "Select Category" --lines 4)

case "$category" in
    *All)
        options=$(cliphist list)
        prompt="Clipboard (All)"
        ;;
    *Text*) 
        options=$(cliphist list | grep -v "\[\[ binary data")
        prompt="Clipboard (Text)"
        ;;
    *Images*)
        options=$(cliphist list | grep "\[\[ binary data")
        prompt="Clipboard (Images)"
        ;;
    *Clear*)
        cliphist wipe
        rm -rf "$HOME/.cache/cliphist/thumbnails"/*
        notify-send "Clipboard" "History cleared" -i edit-clear
        exit 0
        ;;
    *)
        exit 0
        ;;
esac

if [ -z "$options" ]; then
    notify-send "Clipboard" "No items found in this category"
    exit 0
fi

# 2. Select Item
selected=$(echo -e "$options" | $WOFI_CMD --prompt "$prompt" --lines 10)

if [ -z "$selected" ]; then
    exit 0
fi

# 3. Process Selection
id=$(echo "$selected" | awk '{print $1}' | grep -oE '[0-9]+' | head -n 1)

if [ -n "$id" ]; then
    # Decode to clipboard
    cliphist decode "$id" | wl-copy
    
    # 4. Auto-Paste (Simulate Ctrl+V)
    # Small delay to allow wofi to close and focus to return
    sleep 0.2
    wtype -M ctrl v -m ctrl
else
    echo "$selected" | wl-copy
    sleep 0.2
    wtype -M ctrl v -m ctrl
fi