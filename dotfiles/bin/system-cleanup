#!/bin/bash
# System Cleanup Script for Root Partition
# Targets /var/cache/pacman/pkg specifically as it's the main space hog.

echo "ğŸ§¹ Starting Root Partition Cleanup..."

# Check if pacman-contrib is installed for paccache
if ! command -v paccache &> /dev/null; then
    echo "âš ï¸ 'pacman-contrib' is not installed. Installing it now..."
    sudo pacman -S --noconfirm pacman-contrib
fi

# 1. Clean Pacman Cache
# Keep only 1 version of installed packages (Standard is 3, strict is 1 for small roots)
echo "ğŸ“¦ Cleaning package cache (keeping 1 version)..."
sudo paccache -rk1

# Remove ALL versions of uninstalled packages
echo "ğŸ—‘ï¸ Removing cache of uninstalled packages..."
sudo paccache -ruk0

# 2. Remove Orphaned Packages
orphans=$(pacman -Qtdq)
if [ -n "$orphans" ]; then
    echo "ğŸ” Found orphans: $orphans"
    echo "ğŸ—‘ï¸ Removing orphaned packages..."
    sudo pacman -Rns $orphans --noconfirm
else
    echo "âœ¨ No orphaned packages found."
fi

# 3. Clean Journal Logs
echo "ğŸ“œ Vacuuming system journals to 50M..."
sudo journalctl --vacuum-size=50M

# 4. Clean Docker (if present)
if command -v docker &> /dev/null; then
    echo "ğŸ³ Pruning unused Docker objects..."
    sudo docker system prune -af --volumes
fi

# 5. Clean /var/tmp (older than 7 days)
echo "ğŸ§¹ Cleaning old temp files in /var/tmp..."
sudo find /var/tmp -type f -atime +7 -delete

echo "âœ… Root cleanup complete!"
